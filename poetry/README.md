# poetry

ここでは`poetry`というツールを利用したPythonパッケージ開発を行います。

# 1. ディレクトリ構成

まず、以下のコマンドを実行します。

```sh
poetry new mypackageabc
```

これにより、以下のようなパッケージの雛形ディレクトリが生成されます。

```
.
├── README.md
└── mypackageabc
    ├── README.md
    ├── mypackageabc
    │   └── __init__.py
    ├── pyproject.toml
    └── tests
        └── __init__.py
```

この状態で後述する`poetry build`を実行するだけでパッケージが生成されます。

パッケージを構成するディレクトリ、ファイルの最小限のものが何なのかがわかり、そこからボトムアップに適宜拡張していく開発方針になるので、自分としてはこちらの方がやりやすいと感じました。

## 2.1. パッケージ、モジュール

`mypackageabc/mypackageabc/`以下に、`setuptools_twine`の時と同様に`my_module.py`と`__init__.py`を配置します。

## 2.2. LICENSE

`setuptools_twine`と同じ`LICENSE`ファイルを配置します。

## 2.3. pyproject.toml

これが一番重要な設定ファイルになります。

既に動作する最低限の項目には記入がされています。

```
[tool.poetry]
name = "mypackageabc"
version = "0.1.0"
description = ""
authors = ["Your Name <you@example.com>"]
readme = "README.md"

[tool.poetry.dependencies]
python = "^3.12"

[build-system]
requires = ["poetry-core"]
build-backend = "poetry.core.masonry.api"
```

あとは[Poetry doumentation](https://cocoatomo.github.io/poetry-ja/pyproject/)の説明に従い、適宜加筆・修正していきましょう。

## 2.4. 仮想環境構築

`poetry`が提供している仮想環境を利用します。

`pyproject.toml`を読み込むため、`pyproject.toml`の作り込みがひと段落してからが良さそうです。

以下のように実行するだけです。

```shell
poetry shell
```

これは仮想環境の内部に入ってしまい、そこでツールインストールなど何か作業するやり方ですが、以下のように、仮想環境外部から、環境何に向けて何かコマンドを実行するというやり方もできます。

```shell
poetry run 何かコマンド
```

## 2.5. 依存パッケージの追加

実装したオブジェクトに利用した依存パッケージは、以下のように`poetry add`コマンドを実行します。

```shell
poetry add numpy # 関数の実装
```

これにより`pyproject.toml`に`numpy`に関する記述がなされます。

```toml
# pyproject.toml

[tool.poetry.dependencies]
python = "^3.10"
numpy = "^1.26.3"
```

実装した関数やクラスの機能性には直接関係しないが、パッケージを開発する時だけに利用するようなパッケージに関しては、以下のように`--group`オプションを指定し、用途がわかるように`test`や`docs`などラベルをつけながらインストールします。

```shell
poetry add --group test pytest # テスト
poetry add --group test pytest-cov # テスト
poetry add --group docs sphinx # ドキュメント
poetry add --group dev flake8 # Linter
poetry add --group dev black # Formatter
```

これにより`pyproject.toml`に以下のような追記がなされます。

```toml
# pyproject.toml

[tool.poetry.group.test.dependencies]
pytest = "^8.0.0"
pytest-cov = "^4.1.0"


[tool.poetry.group.docs.dependencies]
sphinx = "^7.2.6"


[tool.poetry.group.dev.dependencies]
black = "^24.1.1"
flake8 = "^7.0.0"
```

またこの時に`poetry.lock`というファイルが生成されます。

## 補足: pyproject.tomlとpoetry.lock

`pyproject.toml`は開発者が記入（+ 一部`poetry`が追記）していくのに対して、`poetry.lock`は`poetry`が自動生成し、開発者は触らないことを想定したファイルになります。

中身を見てみると、以下のように実際に現在インストールされた依存パッケージの名前やバージョン、その他詳細情報が記載されていることがわかります。

```toml
# This file is automatically @generated by Poetry 1.7.1 and should not be changed by hand.

[[package]]
name = "colorama"
version = "0.4.6"
description = "Cross-platform colored terminal text."
optional = false
python-versions = "!=3.0.*,!=3.1.*,!=3.2.*,!=3.3.*,!=3.4.*,!=3.5.*,!=3.6.*,>=2.7"
files = [
    {file = "colorama-0.4.6-py2.py3-none-any.whl", hash = "sha256:4f1d9991f5acc0ca119f9d443620b77f9d6b33703e51011c16baf57afb285fc6"},
    {file = "colorama-0.4.6.tar.gz", hash = "sha256:08695f5cb7ed6e0531a20572697297273c47b8cae5a63ffc6d6ed5c201be6e44"},
]

...省略...
```

このファイルがあるパッケージは、環境が変わっても`poetry install`を実行するだけで、同一のバージョンの依存パッケージで構成されたパッケージをインストールすることができます。

この機能は、同じプロジェクトに携わるメンバー間で環境を揃えるときなどに有用だと考えられる一方で、そのツールを別のユーザーが使う場面を想定した時に、全く同じバージョンの依存パッケージを揃えることをユーザーに強いることになるため、時として現実的ではないでしょう（例: そのパッケージを動かすために、別のパッケージのバージョンを下げる、それにより一部の機能が使えなくなる、など）。

[Poetryの公式ドキュメント](https://python-poetry.org/docs/basic-usage/#committing-your-poetrylock-file-to-version-control)では、第三者にパッケージを配布する際には、`poetry.lock`を含めないか、常に`poetry.lock`の内容を最新のものに更新し続けるやり方が紹介されています。

# 3. テスト

`tests`以下に`setuptools_twine`と同じ`test_my_array.py`と`test_my_func.py`を配置します。

テストは、`poetry`コマンドで以下のように実行します。

```shell
poetry run pytest -v
poetry run pytest --cov=mypackageabc -v
```

# 4. インストール

以下のようにして、Pythonに自作のパッケージをインストールします。

```shell
poetry install
```

`poetry`では、インストールはデフォルトでeditableモードになっています。

# 5. ビルド

```shell
poetry build
```

とするだけで、ソースコード/Wheel形式のパッケージが`dist`以下に生成されます。

これにより、最終的に以下のようなディレクトリ構成になります。

```
.
├── LICENSE
├── README.md
├── dist
│   ├── mypackageabc-0.99.1-py3-none-any.whl
│   └── mypackageabc-0.99.1.tar.gz
├── mypackageabc
│   ├── __init__.py
│   └── my_module.py
├── poetry.lock
├── pyproject.toml
└── tests
    ├── __init__.py
    ├── test_my_array.py
    └── test_my_func.py
```

# 6. 配布

`poetry`コマンドを使って、作成したパッケージをTestPyPI(練習用レポジトリ)
やPyPI(練習用レポジトリ)に公開します。
（`setuptools_twine`の時と同様、事前にアカウント登録をしている前提です）

## 6.1 TestPyPIへのリリース

まず`testpypi`という名前で、TestPyPIのURLを登録します。

```shell
poetry config repositories.testpypi https://test.pypi.org/legacy/
```

次に、API Tokenを設定します。

```shell
poetry config pypi-token.testpypi "Test PyPIのAPI Token"
```

あとは、以下のように実行するだけです。

```shell
poetry publish -r testpypi
```
これにより、

https://test.pypi.org/project/mypackageabc/0.99.1/

のようなWebサイトが作成され、作成したパッケージが、誰でも使えるようになりました。

## 6.2 PyPIへのリリース

手順は、TestPyPIの時と同様です。

```shell
poetry config pypi-token.pypi "PyPIのAPI Token"
poetry publish
```

# 7. CI

```setuptools_twine```と同じ```python-package.yml```今回作成したパッケージにも適用しました。
